<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Trading Simulator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ApexCharts for the candlestick chart -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray background */
            color: #F9FAFB; /* Light gray text */
        }
        .btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-buy { background-color: #10B981; color: white; }
        .btn-buy:hover { background-color: #059669; }
        .btn-sell { background-color: #EF4444; color: white; }
        .btn-sell:hover { background-color: #DC2626; }
        .btn-hold { background-color: #3B82F6; color: white; }
        .btn-hold:hover { background-color: #2563EB; }
        .btn:disabled {
            background-color: #4B5563;
            cursor: not-allowed;
            opacity: 0.7;
            transform: translateY(0);
            box-shadow: none;
        }
        /* Custom tooltip for ApexCharts */
        .apexcharts-tooltip {
            background: #1F2937;
            color: #4A4A4A;
            border: 1px solid #374151;
        }
        .apexcharts-tooltip-title {
            background: #374151;
            border-bottom: 1px solid #4B5563;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 md:p-8">

    <div class="w-full max-w-7xl mx-auto bg-gray-900 rounded-2xl shadow-2xl p-4 md:p-8 space-y-6">
        
        <header class="text-center border-b border-gray-700 pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">Stock Trading Simulator</h1>
            <p class="text-gray-400 mt-2">Buy low, sell high. Can you beat the market?</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-3 space-y-4">
                <!-- Main Chart Area -->
                <div id="chart-container" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                    <div id="chart"></div>
                </div>
                <!-- RSI Chart Area -->
                <div id="rsi-chart-container" class="bg-gray-800 p-4 rounded-xl shadow-lg hidden">
                    <div id="rsi-chart"></div>
                </div>
                <!-- KDJ Chart Area -->
                <div id="kdj-chart-container" class="bg-gray-800 p-4 rounded-xl shadow-lg hidden">
                    <div id="kdj-chart"></div>
                </div>
            </div>

            <!-- Controls and Portfolio -->
            <div class="flex flex-col justify-between bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
                
                <div class="space-y-4 text-center">
                    <div>
                        <h2 class="text-lg font-medium text-gray-400">Cash</h2>
                        <p id="money-counter" class="text-4xl font-bold text-green-400">$10,000.00</p>
                    </div>
                    <div>
                        <h2 class="text-lg font-medium text-gray-400">Shares Held</h2>
                        <p id="shares-counter" class="text-4xl font-bold text-blue-400">0</p>
                    </div>
                    <div>
                        <h2 class="text-lg font-medium text-gray-400">Portfolio Value</h2>
                        <p id="portfolio-value" class="text-4xl font-bold text-white">$10,000.00</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <button id="buy-button" class="btn btn-buy w-full py-3 rounded-lg text-lg font-bold">BUY</button>
                    <button id="hold-button" class="btn btn-hold w-full py-3 rounded-lg text-lg font-bold">HOLD</button>
                    <button id="sell-button" class="btn btn-sell w-full py-3 rounded-lg text-lg font-bold" disabled>SELL</button>
                </div>

                <!-- Indicator Settings -->
                <div class="space-y-4 border-t border-gray-700 pt-4">
                    <h3 class="text-xl font-bold text-center text-white">Indicators</h3>
                    <!-- MA Settings -->
                    <div class="space-y-2">
                        <label class="flex items-center justify-between text-gray-300">
                            <span>Show MA</span>
                            <input type="checkbox" id="toggle-ma" class="form-checkbox h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 rounded" checked>
                        </label>
                        <div id="ma-inputs" class="grid grid-cols-2 gap-2">
                            <input type="number" id="ma1-period" value="5" class="bg-gray-700 text-white rounded p-1 text-center">
                            <input type="number" id="ma2-period" value="10" class="bg-gray-700 text-white rounded p-1 text-center">
                        </div>
                    </div>
                    <!-- RSI Settings -->
                    <label class="flex items-center justify-between text-gray-300">
                        <span>Show RSI</span>
                        <input type="checkbox" id="toggle-rsi" class="form-checkbox h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 rounded">
                    </label>
                    <!-- KDJ Settings -->
                    <label class="flex items-center justify-between text-gray-300">
                        <span>Show KDJ</span>
                        <input type="checkbox" id="toggle-kdj" class="form-checkbox h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 rounded">
                    </label>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const INITIAL_MONEY = 10000;
        const INITIAL_PRICE = 100;
        const INITIAL_DATA_POINTS = 50;
        const M = 0;
        const GAMMA = 2.5;

        // --- STATE VARIABLES ---
        let money = INITIAL_MONEY;
        let shares = 0;
        let currentPrice = INITIAL_PRICE;
        let chartData = [];
        let tradeAnnotations = [];

        // --- DOM ELEMENTS ---
        const moneyCounter = document.getElementById('money-counter');
        const sharesCounter = document.getElementById('shares-counter');
        const portfolioValueDisplay = document.getElementById('portfolio-value');
        const buyButton = document.getElementById('buy-button');
        const holdButton = document.getElementById('hold-button');
        const sellButton = document.getElementById('sell-button');
        // Indicator controls
        const toggleMA = document.getElementById('toggle-ma');
        const toggleRSI = document.getElementById('toggle-rsi');
        const toggleKDJ = document.getElementById('toggle-kdj');
        const maInputsContainer = document.getElementById('ma-inputs');
        const ma1PeriodInput = document.getElementById('ma1-period');
        const ma2PeriodInput = document.getElementById('ma2-period');
        const rsiChartContainer = document.getElementById('rsi-chart-container');
        const kdjChartContainer = document.getElementById('kdj-chart-container');

        // --- CHART SETUP ---
        const commonChartOptions = {
            chart: {
                animations: { enabled: false },
                foreColor: '#9CA3AF',
                toolbar: { show: false },
                events: {
                    // Sync tooltips across charts
                    mouseMove: (event, chartContext, config) => {
                        ApexCharts.exec('price-chart', 'updateOptions', { tooltip: { x: { show: true } } }, false, false);
                        ApexCharts.exec('rsi-chart', 'updateOptions', { tooltip: { x: { show: true } } }, false, false);
                        ApexCharts.exec('kdj-chart', 'updateOptions', { tooltip: { x: { show: true } } }, false, false);
                    }
                }
            },
            grid: { borderColor: '#374151', strokeDashArray: 4 },
            xaxis: { type: 'datetime', axisBorder: { show: false }, axisTicks: { color: '#374151' } },
            tooltip: { theme: 'dark', x: { show: false } }
        };

        const priceChartOptions = {
            ...commonChartOptions,
            series: [],
            chart: { ...commonChartOptions.chart, id: 'price-chart', type: 'candlestick', height: 350, group: 'stock-charts' },
            title: { text: 'Stock Price', align: 'left', style: { fontSize: '18px', color: '#F9FAFB' } },
            yaxis: { tooltip: { enabled: true }, labels: { formatter: (val) => `$${val.toFixed(2)}` } },
            plotOptions: { candlestick: { colors: { upward: '#10B981', downward: '#EF4444' } } },
            annotations: { points: [] }
        };
        const rsiChartOptions = {
            ...commonChartOptions,
            series: [{ name: 'RSI', data: [] }],
            chart: { ...commonChartOptions.chart, id: 'rsi-chart', height: 120, group: 'stock-charts' },
            title: { text: 'RSI', align: 'left', style: { fontSize: '14px', color: '#F9FAFB' } },
            yaxis: { min: 0, max: 100, tickAmount: 2 },
            annotations: { yaxis: [ { y: 30, borderColor: '#EF4444', label: { text: 'Oversold' } }, { y: 70, borderColor: '#10B981', label: { text: 'Overbought' } } ]}
        };
        const kdjChartOptions = {
            ...commonChartOptions,
            series: [{ name: 'K', data: [] }, { name: 'D', data: [] }, { name: 'J', data: [] }],
            chart: { ...commonChartOptions.chart, id: 'kdj-chart', height: 120, group: 'stock-charts' },
            title: { text: 'KDJ', align: 'left', style: { fontSize: '14px', color: '#F9FAFB' } },
            yaxis: { min: 0, max: 100, tickAmount: 2 },
            legend: { show: true, position: 'top', horizontalAlign: 'right' },
            stroke: { width: [2, 2, 2] }
        };

        const priceChart = new ApexCharts(document.querySelector("#chart"), priceChartOptions);
        const rsiChart = new ApexCharts(document.querySelector("#rsi-chart"), rsiChartOptions);
        const kdjChart = new ApexCharts(document.querySelector("#kdj-chart"), kdjChartOptions);
        priceChart.render();
        rsiChart.render();
        kdjChart.render();

        // --- INDICATOR CALCULATIONS ---
        const calculateSMA = (data, period) => {
            let sma = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].y[3]; // Use close price
                }
                sma.push({ x: data[i].x, y: (sum / period).toFixed(2) });
            }
            return sma;
        };

        const calculateRSI = (data, period = 14) => {
            let rsi = [];
            let gains = 0, losses = 0;
            for (let i = 1; i < data.length; i++) {
                const change = data[i].y[3] - data[i - 1].y[3];
                if (i < period) {
                    if (change > 0) gains += change; else losses -= change;
                } else {
                    if (i === period) {
                        gains /= period;
                        losses /= period;
                    }
                    const currentGain = change > 0 ? change : 0;
                    const currentLoss = change < 0 ? -change : 0;
                    gains = (gains * (period - 1) + currentGain) / period;
                    losses = (losses * (period - 1) + currentLoss) / period;
                }
                if (i >= period -1) {
                    const rs = losses === 0 ? 100 : gains / losses;
                    rsi.push({ x: data[i].x, y: (100 - (100 / (1 + rs))).toFixed(2) });
                }
            }
            return rsi;
        };
        
        const calculateKDJ = (data, n = 9, kPeriod = 3, dPeriod = 3) => {
            let rsvs = [];
            let ks = [], ds = [], js = [];
            for(let i = 0; i < data.length; i++) {
                const startIndex = Math.max(0, i - n + 1);
                const periodData = data.slice(startIndex, i + 1);
                const lowestLow = Math.min(...periodData.map(p => p.y[2]));
                const highestHigh = Math.max(...periodData.map(p => p.y[1]));
                const close = data[i].y[3];
                const rsv = highestHigh === lowestLow ? 50 : ((close - lowestLow) / (highestHigh - lowestLow)) * 100;
                rsvs.push(rsv);

                if (i > 0) {
                    const lastK = ks.length > 0 ? ks[ks.length-1].y : 50;
                    const newK = (2/3) * lastK + (1/3) * rsv;
                    ks.push({ x: data[i].x, y: newK.toFixed(2) });

                    const lastD = ds.length > 0 ? ds[ds.length-1].y : 50;
                    const newD = (2/3) * lastD + (1/3) * newK;
                    ds.push({ x: data[i].x, y: newD.toFixed(2) });

                    const newJ = 3 * newK - 2 * newD;
                    js.push({ x: data[i].x, y: newJ.toFixed(2) });
                } else {
                     ks.push({ x: data[i].x, y: 50 });
                     ds.push({ x: data[i].x, y: 50 });
                     js.push({ x: data[i].x, y: 50 });
                }
            }
            return { k: ks, d: ds, j: js };
        };


        // --- CORE LOGIC ---
        const breitWignerRandom = () => M + GAMMA * Math.tan(Math.PI * 0.5 * (Math.random() - 0.5));

        function generateNextCandle(lastClose, time) {
            const open = lastClose;
            let change = breitWignerRandom();
            let close = Math.max(1, open + change);
            const volatility = Math.abs(change) * (1 + Math.random());
            const high = Math.max(open, close) + volatility * 0.5;
            const low = Math.min(open, close) - volatility * 0.5;
            currentPrice = parseFloat(close.toFixed(2));
            return {
                x: time,
                y: [open.toFixed(2), high.toFixed(2), low.toFixed(2), close.toFixed(2)].map(parseFloat)
            };
        }

        function updateAllCharts() {
            // Price Chart
            const series = [{ name: 'Price', type: 'candlestick', data: chartData }];
            if (toggleMA.checked) {
                const ma1Period = parseInt(ma1PeriodInput.value) || 5;
                const ma2Period = parseInt(ma2PeriodInput.value) || 10;
                series.push({ name: `MA ${ma1Period}`, type: 'line', data: calculateSMA(chartData, ma1Period) });
                series.push({ name: `MA ${ma2Period}`, type: 'line', data: calculateSMA(chartData, ma2Period) });
            }
            priceChart.updateOptions({ series, annotations: { points: tradeAnnotations } });
            
            // RSI Chart
            if (toggleRSI.checked) {
                rsiChartContainer.classList.remove('hidden');
                rsiChart.updateSeries([{ data: calculateRSI(chartData) }]);
            } else {
                rsiChartContainer.classList.add('hidden');
            }

            // KDJ Chart
            if (toggleKDJ.checked) {
                kdjChartContainer.classList.remove('hidden');
                const { k, d, j } = calculateKDJ(chartData);
                kdjChart.updateSeries([{ name: 'K', data: k }, { name: 'D', data: d }, { name: 'J', data: j }]);
            } else {
                kdjChartContainer.classList.add('hidden');
            }
        }

        function updateUI() {
            moneyCounter.textContent = money.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            sharesCounter.textContent = shares.toLocaleString();
            const portfolioValue = money + (shares * currentPrice);
            portfolioValueDisplay.textContent = portfolioValue.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            
            updateAllCharts();

            buyButton.disabled = money < currentPrice;
            sellButton.disabled = shares === 0;
        }

        function advanceTime() {
            const lastClose = chartData.length > 0 ? chartData[chartData.length - 1].y[3] : INITIAL_PRICE;
            const lastTime = chartData.length > 0 ? chartData[chartData.length - 1].x : new Date().getTime() - 86400000;
            const newTime = new Date(lastTime).getTime() + 86400000;
            const newCandle = generateNextCandle(lastClose, newTime);
            chartData.push(newCandle);
            if (chartData.length > 200) chartData.shift();
            updateUI();
        }

        function initialize() {
            let lastClose = INITIAL_PRICE;
            let time = new Date().getTime() - (INITIAL_DATA_POINTS * 86400000);
            for (let i = 0; i < INITIAL_DATA_POINTS; i++) {
                const newCandle = generateNextCandle(lastClose, new Date(time));
                chartData.push(newCandle);
                lastClose = newCandle.y[3];
                time += 86400000;
            }
            updateUI();
        }

        // --- EVENT LISTENERS ---
        buyButton.addEventListener('click', () => {
            if (money >= currentPrice) {
                const sharesToBuy = Math.floor(money / currentPrice);
                const cost = sharesToBuy * currentPrice;
                shares += sharesToBuy;
                money -= cost;
                
                tradeAnnotations.push({
                    x: chartData[chartData.length - 1].x, y: currentPrice,
                    marker: { size: 6, fillColor: '#fff', strokeColor: '#059669', radius: 2 },
                    label: { text: 'B', borderColor: '#059669', style: { color: '#fff', background: '#059669' } }
                });
                advanceTime();
            }
        });

        sellButton.addEventListener('click', () => {
            if (shares > 0) {
                const earnings = shares * currentPrice;
                money += earnings;
                
                 tradeAnnotations.push({
                    x: chartData[chartData.length - 1].x, y: currentPrice,
                    marker: { size: 6, fillColor: '#fff', strokeColor: '#DC2626', radius: 2 },
                    label: { text: 'S', borderColor: '#DC2626', style: { color: '#fff', background: '#DC2626' } }
                });
                shares = 0;
                advanceTime();
            }
        });
        
        holdButton.addEventListener('click', () => advanceTime());

        [toggleMA, toggleRSI, toggleKDJ, ma1PeriodInput, ma2PeriodInput].forEach(el => {
            el.addEventListener('change', updateUI);
        });

        // --- START SIMULATION ---
        initialize();
    </script>
</body>
</html>
